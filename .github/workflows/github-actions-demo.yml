name: CyRSoXS Build and Test
run-name: CyRSoXS Build-n-Test initiated by ${{ github.actor }}
on: 
  pull_request:
    branches: [ main ]
  push:

      
jobs:
  CyRSoXS-Build-and-Test:
    runs-on: self-hosted
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Provide diagnostic data
        run: echo "Trigger ${{ github.event_name }}, running on ${{ runner.os }}, working on ${{ github.repository }} @ ${{ github.ref }}."
      - name: Clone cyrsoxs code
        uses: actions/checkout@v3
      - name: Cache conda
        uses: actions/cache@v2
        env:
          # Increase this value to reset cache if etc/example-environment.yml has not changed
          CACHE_NUMBER: 0
        with:
          path: ~/ghactions-local/conda_pkgs_dir
          key:
            ${{ runner.os }}-conda-${{ env.CACHE_NUMBER }}-${{
            hashFiles('environment-build.yml') }}
      - name: Check out NRSS code
        uses: actions/checkout@v3
        with:
          repository: usnistgov/NRSS    
          ref: main
          path: ${{ github.workspace }}/NRSS/
      - name: Setup Python and Conda
        uses: conda-incubator/setup-miniconda@v2
        with:
          miniforge-version: "latest"
          activate-environment: cyrsoxs-build
          environment-file: environment-build.yml
          python-version: 3.9          
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - name: Install NRSS/run dependencies
        run: |
            # $CONDA is an environment variable pointing to the root of the miniconda directory
            $CONDA/bin/mamba env update --file NRSS/environment.yml
            $CONDA/bin/mamba remove -n nrss -y cyrsoxs
      - name: Checkout PyBind
        run: |
          git submodule update --init
      - name: Build standalone binaries
        run: |
          conda activate cyrsoxs-build
          cd ${{ github.workspace }}
          mkdir build;
          cd build;
          cmake .. -DCMAKE_BUILD_TYPE=Release;
          make
      - name: Build with Pybind
        run: |
          conda activate cyrsoxs-build
          cd ${{ github.workspace }}
          mkdir build-pybind;
          cd build-pybind;
          cmake .. -DCMAKE_BUILD_TYPE=Release -DPYBIND=Yes -USE_SUBMODULE_PYBIND=Yes;
          make
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
          ls ${{ github.workspace }}/NRSS
      - name: Upload the built CyRSoXS binary as an artifact
        uses: actions/upload-artifact@v3
        with:
          name: CyRSoXS
          path: build/CyRSoXS

      - name: Upload the built CyRSoXS Python library as an artifact
        uses: actions/upload-artifact@v3
        with:
          name: CyRSoXS.*.so
          path: build-pybind/CyRSoXS.so      
      - name: Test that CyRSoXS actually starts
        if: False
        run: |
          conda activate nrss
          build/CyRSoXS
      - name: Test that PyBind-built CyRSoXS actually can be imported.
        run: |
          conda activate nrss
          cd ${{ github.workspace }}
          python -c "import sys; sys.path.insert(0,'build-pybind');import CyRSoXS;"
      - name: Post report on issue
        uses: actions/github-script@v5
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'This PR built and tested successfully, see attachments.'
            })
